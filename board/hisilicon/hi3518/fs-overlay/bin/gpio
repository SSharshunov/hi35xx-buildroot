#!/bin/sh
#
# ZFT Lab. 2018 | https://zftlab.org/pages/2018020900.html
# Hisilicon HI35xx simple GPIO monitor


ircut1="38"
ircut2="39"
ctl="/sys/class/gpio/gpio"


help() {
  clear
  echo -e "\nPlease select command:"
  echo ""
  echo " gpio ircut_on"
  echo " gpio ircut_off"
  echo " gpio info"
  echo " gpio debug"
  echo " gpio search"
  echo ""
}

ircut_on() {
  echo "Probe set IRCUT to ON"
  [ ! -f /sys/class/gpio/export ] && exit
  [ ! -d ${ctl}${ircut1} ] && echo ${ircut1} >/sys/class/gpio/export
  [ -f ${ctl}${ircut1}/direction ] && echo out > ${ctl}${ircut1}/direction && \
    (echo 1 >${ctl}${ircut1}/value ; usleep 250 ; echo 0 >${ctl}${ircut1}/value ; echo in > ${ctl}${ircut1}/direction)
}

ircut_off() {
  echo "Probe set IRCUT to OFF"
  [ ! -f /sys/class/gpio/export ] && exit
  [ ! -d ${ctl}${ircut2} ] && echo ${ircut2} >/sys/class/gpio/export
  [ -f ${ctl}${ircut2}/direction ] && echo out > ${ctl}${ircut2}/direction && \
    (echo 1 >${ctl}${ircut2}/value ; usleep 250 ; echo 0 >${ctl}${ircut2}/value ; echo in > ${ctl}${ircut2}/direction)
}

info() {
  clear
  echo "Mount DEBUGFS and get info about all GPIO"
  [ -f /sys/kernel/debug/gpio ] || mount -t debugfs none /sys/kernel/debug >/dev/null 2>&1
  [ -f /sys/kernel/debug/gpio ] && cat /sys/kernel/debug/gpio
}

debug() {
  clear
  echo "Mount DEBUGFS and get info about all GPIO"
  [ -f /sys/kernel/debug/gpio ] || mount -t debugfs none /sys/kernel/debug >/dev/null 2>&1
  [ -f /sys/kernel/debug/gpio ] && watch "cat /sys/kernel/debug/gpio"
}

search() {
  clear
  echo "Start blink (output) on all gpio"
  echo ""
  for pin in $(seq 0 88); do
    echo "================================="
    [ ! -f /sys/class/gpio/export ] && exit
    [ ! -d ${ctl}${pin} ] && echo ${pin} >/sys/class/gpio/export && echo "Activate in system GPIO-${pin}"
    [ -f ${ctl}${pin}/direction ] && echo out >${ctl}${pin}/direction && echo "  Set GPIO-${pin} to OUTPUT mode"
    [ -f ${ctl}${pin}/value ] && echo 0 >${ctl}${pin}/value && echo "    Set GPIO-${pin} to LO level" ; sleep 1
    [ -f ${ctl}${pin}/value ] && echo 1 >${ctl}${pin}/value && echo "    Set GPIO-${pin} to HI level" ; sleep 1
    [ -f ${ctl}${pin}/direction ] && echo in >${ctl}${pin}/direction && echo "  Set GPIO-${pin} to INPUT mode"
    #[ -d ${ctl}${pin} ] && echo ${pin} >/sys/class/gpio/unexport && echo "Remove from system GPIO-${pin}"
  done
}

blink() {
  echo "Start blink (output) on selected gpio"
  [ ! -f ${sys}${2}/value ] && exit
  while [ true ]; do
    echo 0 > ${sys}${2}/value ; sleep 1
    echo 1 > ${sys}${2}/value ; sleep 1
  done
}


if [ $# -ge 1 ]; then
  ${1}
else
  help
fi
